# example workflow for Finite State scans using the CLT
name: fs-clt
on:
  push:
    branches: [ main, master, develop, stage, release ]
  pull_request:
    branches: [ main, master, develop, stage, release ]
  workflow_dispatch:
jobs:
  finitestate:
    runs-on: ubuntu-latest
    env:
      FINITE_STATE_DOMAIN: ${{ vars.FINITE_STATE_DOMAIN }}
      FINITE_STATE_AUTH_TOKEN: ${{ secrets.FINITE_STATE_AUTH_TOKEN }}
      GITHUB_USER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_REPOSITORY_OWNER_NAME: ${{ github.repository_owner }}
      GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
      GITHUB_REPOSITORY_BRANCH_NAME: ${{ github.ref_name }}
    steps:
    - name: Checkout Source
      uses: actions/checkout@v6
    - name: Setup Java JDK
      uses: actions/setup-java@v5
      with:
        java-version: 25
        distribution: temurin
        cache: maven
    - name: Maven Build
      run: mvn -B -DskipTests package
    - name: Finite State Full Scan
      if: ${{ github.event_name != 'pull_request' }}
      env:
        PROJECT_NAME: ${{ github.event.repository.name }}
        PROJECT_VERSION: ${{ github.ref_name }}
      run: |
        curl -X 'GET' "https://$FINITE_STATE_DOMAIN/api/config/clt" \
          -H "X-Authorization: $FINITE_STATE_AUTH_TOKEN" \
          -o finitestate.jar

        echo "=== Running Finite State CLI ==="
        echo "PROJECT_NAME: $PROJECT_NAME"
        echo "PROJECT_VERSION: $PROJECT_VERSION"
        
        set +e
        java -jar finitestate.jar --scan --name=$PROJECT_NAME --version=$PROJECT_VERSION --all
        EXIT_CODE=$?
        set -e
        
        echo "=== Finite State CLI Exit Code: $EXIT_CODE ==="
        
        if [ $EXIT_CODE -ne 0 ] && [ $EXIT_CODE -ne 1 ]; then
          echo "=== Finite State CLI failed with exit code $EXIT_CODE ==="
          echo "Checking for log files..."
          find . -name "*.log" -type f 2>/dev/null | while read logfile; do
            echo "=== Contents of $logfile ==="
            cat "$logfile"
          done
          exit $EXIT_CODE
        fi
        
        echo "=== Finite State CLI completed successfully (exit code: $EXIT_CODE) ==="
        exit 0
    - name: Finite State PR Scan
      if: ${{ github.event_name == 'pull_request' }}
      env:
        PROJECT_NAME: ${{ github.event.repository.name }}
        PROJECT_VERSION_NAME: ${{ github.base_ref }}
      run: |
        curl -X 'GET' "https://$FINITE_STATE_DOMAIN/api/config/clt" \
          -H "X-Authorization: $FINITE_STATE_AUTH_TOKEN" \
          -o finitestate.jar

        echo "=== Running Finite State CLI ==="
        echo "PROJECT_NAME: $PROJECT_NAME"
        echo "PROJECT_VERSION_NAME: $PROJECT_VERSION_NAME"
        
        set +e
        java -jar finitestate.jar --scan --name=$PROJECT_NAME --version=$PROJECT_VERSION_NAME
        EXIT_CODE=$?
        set -e
        
        echo "=== Finite State CLI Exit Code: $EXIT_CODE ==="
        
        if [ $EXIT_CODE -ne 0 ] && [ $EXIT_CODE -ne 1 ]; then
          echo "=== Finite State CLI failed with exit code $EXIT_CODE ==="
          echo "Checking for log files..."
          find . -name "*.log" -type f 2>/dev/null | while read logfile; do
            echo "=== Contents of $logfile ==="
            cat "$logfile"
          done
          exit $EXIT_CODE
        fi
        
        echo "=== Finite State CLI completed successfully (exit code: $EXIT_CODE) ==="
        exit 0
#    - name: Save Logs
#      if: always()
#      uses: actions/upload-artifact@v4
#      with:
#        name: bridge-logs
#        path: ${{ github.workspace }}/.bridge
#        include-hidden-files: true
